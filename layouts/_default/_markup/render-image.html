{{- $u := urls.Parse .Destination -}}
{{- $src := $u.String -}}

{{- /* Fix for Obsidian paths starting with static/ or ../../static/ */ -}}
{{- if strings.HasPrefix $src "static/" -}}
{{- $src = printf "/%s" (strings.TrimPrefix "static/" $src) -}}
{{- $u = urls.Parse $src -}}
{{- else if strings.Contains $src "/static/" -}}
{{/* Handle potential relative adjustments like ../../static/ */}}
{{- $parts := split $src "/static/" -}}
{{- if eq (len $parts) 2 -}}
{{- $src = printf "/%s" (index $parts 1) -}}
{{- $u = urls.Parse $src -}}
{{- end -}}
{{- end -}}

{{- if not $u.IsAbs -}}
{{- $path := strings.TrimPrefix "./" $u.Path }}
{{- with or (.PageInner.Resources.Get $path) (resources.Get $path) -}}
{{- $src = .RelPermalink -}}
{{- with $u.RawQuery -}}
{{- $src = printf "%s?%s" $src . -}}
{{- end -}}
{{- with $u.Fragment -}}
{{- $src = printf "%s#%s" $src . -}}
{{- end -}}
{{- end -}}
{{- end -}}
{{- $attributes := merge .Attributes (dict "alt" .Text "src" $src "title" (.Title | transform.HTMLEscape) "loading"
"lazy") -}}
<img {{- range $k, $v :=$attributes -}} {{- if $v -}} {{- printf " %s=%q" $k $v | safeHTMLAttr -}} {{- end -}} {{- end
    -}}>
{{- /**/ -}}